var index={manage_money_tpl:_.template($("#manage_money_tpl").html()),manage_status_tpl:_.template($("#manage_status_tpl").html()),ready_init:function(){var e=this,t=$("#manage-money-radius"),a=$.trim(e.manage_money_tpl());t.html(a),e.icon_box(),index.init_ajax("china"),$(".progress-visit").css("display","none"),e.small_bg()},small_bg:function(){var e=this,t={lineWidth:.5,lineCap:"butt",strokeStyle:"rgba(63,63,63,0.2)",data:[]},a=20,n=$("#small-bg"),i=$(".right-content"),r=n.parent().width()-2*a,s=n.parent().height(),o=Math.ceil(r/a),c=r-Math.floor(r/a)*a,p=s-Math.floor(s/a)*a,u=Math.floor(2*o/3)*a-3*a,l=r-u;$(".map-content").css({right:l+"px"}),i.css({left:u+"px"}),$(".body-content").css({"margin-right":a+c+"px","margin-bottom":a+p+"px"}),$(".content").css({"padding-right":a+c+"px","padding-bottom":a+p+"px"});var h=i.height(),_=Math.ceil(h/a),m=Math.floor(2*_/3)*a,d=h-m;$(".meter-box").css({bottom:m+"px"}),$(".manage-box").css({top:d+"px"}),e.img_rotate(),e.canvas_line(t,"small-bg",a)},map_bg:function(){var e=this,t={lineWidth:.5,lineCap:"butt",strokeStyle:"#192e34",data:[]},a=parseInt($(".manage-box").css("top"));e.canvas_line(t,"map-bg",a,!0)},canvas_line:function(e,t,a,n){var i=new canvasMap,r=$.extend({},e),s=$.extend({},e),o=$("#"+t).parent(),c=o.width(),p=o.height(),u=Math.ceil(c/a),l=Math.ceil(p/a);_(l).times(function(e){n&&(a*e<p&&e===l-1&&r.data.push({start:{x:0,y:p},end:{x:c,y:p}}),e-=1),r.data.push({start:{x:0,y:(e+1)*a},end:{x:c,y:(e+1)*a}})}),_(u).times(function(e){if(n){if(a*e<c&&e===u-1){s.data.push({start:{x:c,y:0},end:{x:c,y:p}})}e-=1}s.data.push({start:{x:(e+1)*a,y:0},end:{x:(e+1)*a,y:p}})}),i.init(document.getElementById(t)),i.horizontal_line(r),i.horizontal_line(s)},icon_box:function(){$(".icon-box").each(function(){var e=$(this),t=e.outerHeight();e.css("width",t+"px")})},select_con_text:function(e){var t,a=this,n=e.attr("id"),i=e.text().replace("：",""),r=Number(n.replace(/\w+_/,"")),s=$(".header-title"),o=$(".total-hospital-num"),c=$("#manage-money-radius"),p=$("body");if(p.find(".hospital-alert").remove(),e.closest(".map-select-content").find(".select-con-text").removeClass("active"),e.addClass("active"),$(".map-select-text").text(i).data("id",n),"china"===n){t="china";var u=a.manage_money_tpl();c.html(u),$(".progress-visit").css("display","none")}else{$(".progress-visit").css("display","block"),isNaN(r)?t=n+".geo":_.each(GVR.JSON.provinceArray,function(e,a){if(e===i)return t="province_"+GVR.JSON.provinceJson[a],!1});var l=a.manage_status_tpl();c.html(l)}a.icon_box(),a.init_ajax(t),s.text(i+"进度总览"),o.text(i+"医院总数")},img_rotate:function(){var e=284/168,t=163/26,a=1.42,n=$(".meter-img"),i=n.height(),r=n.width(),s=$(".meter-arrow"),o=$(".half-rect-1");$(".img-rotate").each(function(n,c){var p,u,l=$(c),h=l.width();i*Math.sin(2*Math.PI/5);if(h>i?(h=i,u=(r-2*h)/2):(h=.45*r,u="5%"),p=h/e,l.css({width:h+"px",height:p+"px",left:u}),0===n){var _=h/a,m=_/t,d=(r-2*_)/2;s.css({width:_+"px",height:m+"px",left:d-5+"px"});var x=2*h/3,g=(r-x)/2;o.css({height:x/2+"px",width:x+"px",left:g+"px","border-radius":x/2+"px "+x/2+"px 0 0"}),$(".half-react").each(function(e,t){if(e>0){var a=.85*x,n=.8*a,i=(x-a)/2,r=(a-n)/2;1===e?$(t).css({height:a/2+"px",width:a+"px",left:i+"px","border-radius":a/2+"px "+a/2+"px 0 0"}):2===e&&$(t).css({"line-height":n/2+8+"px",height:n/2+"px",width:n+"px",left:r+"px","border-radius":n/2+"px "+n/2+"px 0 0"})}})}})},init_ajax:function(e){var t=this,a={},n=0,i=0,r=0,s=0,o=0,c=0,p=0,u=0,l=0,h=/province_/.test(e),m=/china/.test(e),d=e.replace(/province_/,""),x={palaver:[],purpose:[],arrange:[],train:[],use:[]},g={palaver:{name:"洽谈中",data:[],point:[],color:"#f1635e"},purpose:{name:"确定意向",data:[],point:[],color:"#ffc528"},arrange:{name:"部署中",data:[],point:[],color:"#6bd8ea"},train:{name:"培训中",data:[],point:[],color:"#00d991"},use:{name:"使用中",data:[],point:[],color:"#939fdf"}},v={lend_data:["洽谈中","确定意向","部署中","培训中","使用中"],lend_selected:{"洽谈中":!1,"确定意向":!1,"部署中":!1,"培训中":!1,"使用中":!0},max:0,series:[]},f=$("#init-url"),b=$("#content"),y="http://121.42.187.170:9000"+f.attr("url1"),N="http://121.42.187.170:9000"+f.attr("url2");$.when(t.returns_ajax_init(f,{},y)).then(function(f){$.when(t.vbigdisplay_ajax_init(b,{},N)).then(function(b){var y=f.concat(b.entity);_.each(b.otherInfo,function(t){if(h){if(!t.province)return!0;var a,n=t.province.replace(/[\u5e02|\u7701]/,"");_.each(GVR.JSON.provinceJson,function(e,t){d===e&&(a=GVR.JSON.provinceArray[t])}),n===a&&t.usage_count&&(l+=parseInt(t.usage_count))}else if(m)t.usage_count&&(l+=parseInt(t.usage_count));else{var i=e.replace(".geo","");t.district!==GVR.JSON.area_json[i][0]+"区"&&t.usage_count&&(l+=parseInt(t.usage_count))}}),_.each(y,function(t,a){if(h){var l,v=t.province.replace(/[\u5e02|\u7701]/,"");if(_.each(GVR.JSON.provinceJson,function(e,t){d===e&&(l=GVR.JSON.provinceArray[t])}),v!==l)return!0}else if(m)t.total_price&&(n+=parseInt(t.total_price));else{var f=e.replace(".geo","");if(t.district!==GVR.JSON.area_json[f][0]+"区")return!0}t.total_num&&(i+=t.total_num),t.received_payments&&(u+=t.received_payments),s+=1;var $;switch(Number(t.business_status)){case 1:$="拜访中",r+=1;break;case 2:$="洽谈中";break;case 3:$="确定意向";break;case 4:$="部署中";break;case 5:$="培训中";break;default:$="使用中",t.business_status=6}switch(Number(t.business_detaile)){case 1:o+=1;break;case 2:c+=1;break;case 3:p+=1}var b={district:t.district,province:t.province,status:$,business_status:t.business_status},y={name:t.hospitals_name||t.hospital_name,coord:[t.lon,t.lat],value:t.hospitals_id};switch(b.status){case"洽谈中":x.palaver.push(b),g.palaver.point.push(y);break;case"确定意向":x.purpose.push(b),g.purpose.point.push(y);break;case"部署中":x.arrange.push(b),g.arrange.point.push(y);break;case"培训中":x.train.push(b),g.train.point.push(y);break;case"使用中":x.use.push(b),g.use.point.push(y)}}),a={palaver_num:x.palaver.length,purpose_num:x.purpose.length,arrange_num:x.arrange.length,train_num:x.train.length,use_num:x.use.length},GVR.JSON.hospital_num=a,m?(_.each(x,function(e,t){var a={db:0,hb:0,hd:0,hn:0,hz:0,xb:0,xn:0};_.each(e,function(e,t){_.each(GVR.JSON.area_json,function(t,n){e.district===t[0]+"区"&&(a[n]=a[n]+1,v.max<a[n]&&(v.max=a[n]))})}),g[t].data.push(a)}),v.series=g,COMMON_FUNC.animate_num($("#money-text"),0,n)):h?v.series=g:(_.each(x,function(e,t){var a={};_.each(e,function(e,t){_.each(GVR.JSON.provinceArray,function(t,n){var i=e.province.replace(/[\u5e02|\u7701]/,"");i===t&&(a[t]?a[t]=a[t]+1:a[t]=1,a[t]&&v.max<a[t]&&(v.max=a[t]))})}),g[t].data.push(a)}),v.series=g),m||(u>1e4?(u=parseInt(u/1e4),$("#received-unit").text("万元")):u>1e8?$("#received-unit").text("亿元"):$("#received-unit").text("元"),COMMON_FUNC.animate_num($("#deliver"),0,o),COMMON_FUNC.animate_num($("#probation"),0,c),COMMON_FUNC.animate_num($("#regular"),0,p),COMMON_FUNC.animate_num($("#received-payments"),0,u));var N=parseInt(r/s*100);$(".progress-con").css("width",N+"%"),$(".progress-num").text(r+"/"+s),COMMON_FUNC.animate_num($("#amount-text"),0,i),COMMON_FUNC.animate_num($("#js-manage-frequency"),0,l),ECHARTS_FUNC.area_total_map("area-total-map",e,v),$(".img-rotate:last").click();var M=document.body.clientWidth;if(M>1920)var O=$(".img-rotate").length,C=0,w=setInterval(function(){C===O-1&&(clearInterval(w),t.init_ajax(e)),$(".img-rotate:eq("+C+")").click(),C++},6e4)})})},returns_ajax_init:function(e,t,a){return COMMON_FUNC.ajax_get(e,t,a,function(e){})},vbigdisplay_ajax_init:function(e,t,a){return COMMON_FUNC.ajax_get(e,t,a,function(e){})}};$(function(){index.ready_init(),$(window).resize(function(){var e=GVR.ECHARTS.AREA_MAP;index.img_rotate(),index.icon_box(),index.small_bg(),e&&e.resize()})}).on("click",".select-con-text",function(){index.select_con_text($(this))});